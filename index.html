<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pflugsmühle Hotelshop</title>
  <meta name="description" content="Pflugsmühle Hotelshop – Snacks & Getränke bequem aufs Zimmer." />
  <style>
    :root{
      --bg:#ffffff; --surface:#f8fafc; --card:#ffffff; --border:#e2e8f0; --muted:#475569; --text:#0f172a;
      --acc:#0ea5e9; --accText:#07263a; --danger:#ef4444; --success:#16a34a;
      --radius:14px; --pad:14px; --shadow: 0 8px 24px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{font-size:1.5rem;margin:0}
    .badge{background:var(--surface);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted)}
    .layout{display:grid;grid-template-columns:2fr 1fr;gap:18px}
    @media (max-width:960px){.layout{grid-template-columns:1fr}}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px}
    .price{font-weight:700}
    .muted{color:var(--muted)}
    .btn{cursor:pointer;border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px 14px;font-weight:600}
    .btn-ghost{background:#fff}
    .btn-acc{background:var(--acc);color:#fff;border-color:var(--acc)}
    .btn-danger{background:#fff;color:var(--danger);border-color:var(--danger)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .cart{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);position:sticky;top:12px}
    .qty{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .qty button{all:unset;padding:10px 14px;cursor:pointer;min-width:44px;text-align:center}
    .qty span{min-width:36px;text-align:center;padding:10px 8px}
    .cart-item{display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px dashed var(--border)}
    .cart-item:last-child{border-bottom:0}
    .total{display:flex;justify-content:space-between;font-weight:800;padding-top:8px;border-top:1px solid var(--border);margin-top:6px}
    .field{display:flex;flex-direction:column;gap:6px;margin:6px 0}
    input,select{background:#fff;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:12px}
    label{font-weight:600}
    .radio-row{display:flex;gap:8px;flex-wrap:wrap}
    .radio-pill{display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#fff}
    .msg{min-height:1.2em}
    footer{margin-top:20px;color:var(--muted);font-size:.9rem}
    /* größere Touch-Ziele auf kleinen Screens */
    @media (max-width:520px){
      .btn{padding:14px 16px}
      .qty button{padding:12px 16px;min-width:48px}
      .qty span{min-width:40px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Pflugsmühle Hotelshop</h1>
      <div class="badge">Schnellservice · aufs Zimmer</div>
    </header>

    <div class="layout">
      <main>
        <div id="catalog" class="grid" aria-live="polite"></div>
      </main>

      <aside class="cart" aria-label="Warenkorb">
        <h2 style="margin:0 0 8px 0;font-size:1.2rem">Warenkorb</h2>
        <div id="cartItems" class="muted">Noch keine Artikel</div>
        <div class="total"><span>Summe (Brutto)</span><span id="cartTotal">0,00 €</span></div>

        <form id="checkout" style="margin-top:10px;display:flex;flex-direction:column;gap:10px">
          <div class="field">
            <label for="room">Zimmer</label>
            <select id="room" required>
              <option value="">– bitte wählen –</option>
            </select>
          </div>
          <div class="field">
            <label for="email">E-Mail <span class="muted">(Pflicht)</span></label>
            <input id="email" type="email" required placeholder="gast@example.com" />
          </div>
          <div class="field">
            <label for="name">Name <span class="muted">(optional)</span></label>
            <input id="name" type="text" placeholder="Max Mustermann" />
          </div>
          <div class="field">
            <label>Zahlungsart</label>
            <div class="radio-row" role="radiogroup" aria-label="Zahlungsart">
              <label class="radio-pill"><input type="radio" name="pay" value="Karte" required /> Karte</label>
              <label class="radio-pill"><input type="radio" name="pay" value="Bar" /> Bar</label>
              <label class="radio-pill"><input type="radio" name="pay" value="Zimmerrechnung" /> Zimmerrechnung</label>
            </div>
          </div>
          <button type="submit" class="btn btn-acc">Bestellung senden</button>
          <button type="button" id="clearCart" class="btn btn-danger">Warenkorb leeren</button>
          <div id="msg" class="muted msg" aria-live="polite"></div>
        </form>
      </aside>
    </div>

    <footer>© Pflugsmühle · Dieser Shop ist ein Service für Hausgäste.</footer>
  </div>

  <script>
    // ==== KONFIGURATION ====
    const PRODUCTS_URL = './products.json';   // Datei im Repo
    const ROOMS_URL    = './zimmer.json';     // deine Zimmerliste
    // Später aktivieren: echte Bestellung an euren Server
   const ORDER_ENDPOINT = 'https://vouchers-backend.f-braun.workers.dev/order';
 // z.B. 'https://www.pflugsmuehle.de/pfm/hotelshop/api/order.php'

    // ==== STATE ====
    let products = [];  // {id,name,price_gross,vat_rate}
    let rooms = [];     // {id,name}
    const cart = new Map(); // id -> {product, qty}

    // ==== HELPERS ====
    const money = n => (Number(n||0)).toFixed(2).replace('.', ',') + ' €';
    const sumGross = () => Array.from(cart.values()).reduce((s, it) => s + it.product.price_gross * it.qty, 0);

    function saveCart(){ localStorage.setItem('pfm_cart', JSON.stringify(Array.from(cart.entries()))); }
    function loadCart(){
      try { const raw = JSON.parse(localStorage.getItem('pfm_cart')||'[]'); cart.clear(); raw.forEach(([id, it]) => cart.set(String(id), it)); }
      catch(e){ cart.clear(); }
    }

    // ==== RENDER ====
    function renderRooms(){
      const sel = document.getElementById('room');
      // initial option bleibt erhalten
      rooms.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.name;
        opt.textContent = r.name;
        sel.appendChild(opt);
      });
    }

    function renderCatalog(){
      const root = document.getElementById('catalog');
      root.innerHTML = '';
      products.forEach(p => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div style="font-weight:700">${p.name}</div>
          <div class="muted">inkl. MwSt. (${Number(p.vat_rate).toFixed(0)}%)</div>
          <div class="price">${money(p.price_gross)}</div>
          <div class="row">
            <div class="qty" aria-label="Menge wählen">
              <button type="button" aria-label="minus" onclick="chgQty('${p.id}', -1)">−</button>
              <span id="q_${p.id}">${(cart.get(String(p.id))?.qty)||0}</span>
              <button type="button" aria-label="plus" onclick="chgQty('${p.id}', 1)">+</button>
            </div>
            <button class="btn btn-ghost" type="button" onclick="addToCart('${p.id}')">Hinzufügen</button>
          </div>
        `;
        root.appendChild(el);
      });
    }

    function renderCart(){
      const root = document.getElementById('cartItems');
      if(cart.size === 0){
        root.textContent = 'Noch keine Artikel';
      } else {
        root.innerHTML = '';
        cart.forEach((it, id) => {
          const row = document.createElement('div');
          row.className = 'cart-item';
          row.innerHTML = `
            <div style="flex:1">
              <div>${it.product.name}</div>
              <div class="muted">${it.qty} × ${money(it.product.price_gross)}</div>
            </div>
            <div class="row">
              <div class="qty">
                <button type="button" onclick="chgQty('${id}', -1)">−</button>
                <span id="q_cart_${id}">${it.qty}</span>
                <button type="button" onclick="chgQty('${id}', 1)">+</button>
              </div>
              <button class="btn btn-danger" type="button" onclick="removeItem('${id}')">Entfernen</button>
            </div>
          `;
          root.appendChild(row);
        });
      }
      document.getElementById('cartTotal').textContent = money(sumGross());
      products.forEach(p => {
        const span = document.getElementById('q_'+p.id);
        if(span) span.textContent = (cart.get(String(p.id))?.qty)||0;
      });
    }

    // ==== CART OPS ====
    function chgQty(id, delta){
      id = String(id);
      const p = products.find(x => String(x.id) === id);
      if(!p) return;
      const cur = cart.get(id)?.qty || 0;
      const q = Math.max(0, cur + delta);
      if(q === 0) { cart.delete(id); }
      else { cart.set(id, {product:p, qty:q}); }
      saveCart(); renderCart();
    }
    function addToCart(id){ chgQty(id, 1); }
    function removeItem(id){ cart.delete(String(id)); saveCart(); renderCart(); }

    // ==== CHECKOUT ====
    async function submitOrder(e){
      e.preventDefault();
      const msg = document.getElementById('msg');
      msg.textContent = '';
      if(cart.size === 0){ msg.textContent = 'Bitte fügen Sie zuerst Artikel hinzu.'; return; }

      const room = document.getElementById('room').value.trim();
      const email = document.getElementById('email').value.trim();
      const name = document.getElementById('name').value.trim();
      const pay = [...document.querySelectorAll('input[name="pay"]')].find(r => r.checked)?.value;

      const items = Array.from(cart.values()).map(it => ({
        item_id: String(it.product.id),
        name: it.product.name,
        qty: it.qty,
        price_gross: it.product.price_gross,
        vat_rate: it.product.vat_rate
      }));

      const payload = {
        room, email, name, payment_method: pay, items,
        currency: 'EUR', total_gross: Number(sumGross().toFixed(2))
      };

      if(ORDER_ENDPOINT){
        try{
         const res = await fetch(ORDER_ENDPOINT, {
  method: 'POST', headers: {'Content-Type': 'application/json'},
  body: JSON.stringify(payload)
});

const text = await res.text();
let data = null;
try { data = JSON.parse(text); } catch {}

if (!res.ok) {
  console.error('Worker-Fehler:', res.status, text);
  msg.textContent = 'Fehler ' + res.status + ': ' + (data?.error || text || 'Unbekannt');
  return;
}

if (data?.checkout_url) {
  window.location.href = data.checkout_url;
  return;
}

msg.textContent = 'Antwort ohne checkout_url: ' + (text || '(leer)');

          cart.clear(); saveCart(); renderCart(); (e.target).reset();
          return;
        }catch(err){
          console.error(err);
          msg.textContent = 'Übermittlung fehlgeschlagen. Bitte später erneut versuchen oder Bar / Zimmerrechnung wählen.';
          return;
        }
      }

      // Demo (solange kein Server-Endpunkt gesetzt ist)
      console.log('DEMO – Payload würde gesendet:', payload);
      msg.textContent = 'Demo: Bestellung lokal erfasst. (Server-Endpoint noch nicht konfiguriert.)';
      cart.clear(); saveCart(); renderCart(); (e.target).reset();
    }

    // ==== INIT ====
    document.getElementById('checkout').addEventListener('submit', submitOrder);
    document.getElementById('clearCart').addEventListener('click', () => { cart.clear(); saveCart(); renderCart(); });

    (async function(){
      loadCart();
      try{
        const [pRes, rRes] = await Promise.all([
          fetch(PRODUCTS_URL),
          fetch(ROOMS_URL)
        ]);
        products = await pRes.json();
        rooms    = await rRes.json();
      }catch(e){
        console.error('JSON-Dateien konnten nicht geladen werden', e);
        products = []; rooms = [];
      }
      renderRooms();
      renderCatalog();
      renderCart();
    })();
  </script>
</body>
</html>
